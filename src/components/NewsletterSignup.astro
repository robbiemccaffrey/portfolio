---
interface Props {
  title?: string;
  subtitle?: string;
  compact?: boolean;
}

const {
  title = "Get new posts by email",
  subtitle = "No spam. Just a short email when a new blog post goes live.",
  compact = false,
} = Astro.props;
---

<section class={`rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 ${compact ? "p-5" : "p-6 sm:p-8"}`}>
  <div class="max-w-2xl">
    <p class="text-xs uppercase tracking-widest font-semibold text-blue-600 dark:text-blue-400 mb-2">Newsletter</p>
    <h3 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white tracking-tight">{title}</h3>
    <p class="mt-2 text-sm sm:text-base text-gray-600 dark:text-gray-400 leading-relaxed">{subtitle}</p>
  </div>

  <form id="newsletter-signup-form" class="mt-6 flex flex-col sm:flex-row gap-3">
    <label for="newsletter-email" class="sr-only">Email</label>
    <input
      id="newsletter-email"
      name="email"
      type="email"
      required
      autocomplete="email"
      placeholder="you@company.com"
      class="flex-1 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
    <button
      type="submit"
      class="px-5 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-colors disabled:opacity-60"
    >
      Subscribe
    </button>
  </form>

  <p id="newsletter-signup-message" class="mt-3 text-sm text-gray-500 dark:text-gray-400" aria-live="polite"></p>
</section>

<script>
  const form = document.getElementById("newsletter-signup-form");
  const emailInput = document.getElementById("newsletter-email");
  const message = document.getElementById("newsletter-signup-message");

  if (form && emailInput && message) {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const email = emailInput.value.trim();

      if (!email) {
        message.textContent = "Enter an email address.";
        message.className = "mt-3 text-sm text-red-600 dark:text-red-400";
        return;
      }

      const button = form.querySelector("button[type='submit']");
      if (button) {
        button.disabled = true;
        button.textContent = "Subscribing...";
      }

      try {
        const response = await fetch("/api/newsletter/subscribe", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });
        const payload = await response.json();

        if (!response.ok) {
          message.textContent = payload.error || "Could not subscribe. Try again.";
          message.className = "mt-3 text-sm text-red-600 dark:text-red-400";
          return;
        }

        emailInput.value = "";
        message.textContent = "Subscribed. You will get an email when a new post goes live.";
        message.className = "mt-3 text-sm text-emerald-600 dark:text-emerald-400";
      } catch {
        message.textContent = "Network error. Please try again.";
        message.className = "mt-3 text-sm text-red-600 dark:text-red-400";
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = "Subscribe";
        }
      }
    });
  }
</script>
