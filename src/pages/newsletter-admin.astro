---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";

const posts = (await getCollection("blog"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const postData = posts.map((p) => ({
  slug: p.slug,
  title: p.data.title,
  description: p.data.description,
}));
---

<Layout
  title="Newsletter Admin â€” Robert McCaffrey"
  description="Private admin panel for newsletter subscribers and blog broadcast emails."
>
  <section class="max-w-4xl mx-auto px-4 sm:px-6 py-14">
    <header class="mb-8">
      <p class="text-xs uppercase tracking-widest font-semibold text-blue-600 dark:text-blue-400">Private</p>
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white tracking-tight">Newsletter Admin</h1>
      <p class="mt-3 text-gray-600 dark:text-gray-400">Log in, check subscribers, and trigger a new blog email.</p>
    </header>

    <div id="auth-card" class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6">
      <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Admin Login</h2>
      <form id="login-form" class="space-y-3 max-w-md">
        <input
          id="username"
          type="text"
          autocomplete="username"
          placeholder="Username"
          class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-white"
        />
        <input
          id="password"
          type="password"
          autocomplete="current-password"
          placeholder="Password"
          class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-white"
        />
        <button class="px-4 py-2.5 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors" type="submit">
          Log in
        </button>
      </form>
      <p id="login-msg" class="mt-3 text-sm text-gray-500 dark:text-gray-400"></p>
    </div>

    <div id="admin-card" class="hidden mt-8 space-y-8">
      <div class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6">
        <div class="flex items-center justify-between gap-3 mb-4">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Subscribers</h2>
          <button id="logout-btn" class="text-sm px-3 py-1.5 rounded-md border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800">
            Log out
          </button>
        </div>
        <p id="subscriber-count" class="text-sm text-gray-500 dark:text-gray-400 mb-3">Loading...</p>
        <div class="max-h-[280px] overflow-auto rounded-lg border border-gray-200 dark:border-gray-800">
          <ul id="subscriber-list" class="divide-y divide-gray-200 dark:divide-gray-800 text-sm"></ul>
        </div>
      </div>

      <div class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Send Blog Email</h2>
        <form id="send-form" class="space-y-3">
          <select
            id="post-select"
            class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-white"
          >
            <option value="">Select a blog post...</option>
            {postData.map((p) => (
              <option value={p.slug} data-title={p.title} data-description={p.description}>
                {p.title}
              </option>
            ))}
          </select>
          <input id="post-title" placeholder="Post title" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-white" />
          <input id="post-slug" placeholder="Slug (example: iso27001-at-a-startup)" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-white" />
          <textarea id="post-summary" rows="4" placeholder="Short summary used in the email" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-white"></textarea>
          <input id="preview-text" placeholder="Footer note (optional)" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-white" />
          <button id="send-btn" class="px-4 py-2.5 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors" type="submit">
            Send Email
          </button>
        </form>
        <p id="send-msg" class="mt-3 text-sm text-gray-500 dark:text-gray-400"></p>
      </div>
    </div>
  </section>
</Layout>

<script>
  const authCard = document.getElementById("auth-card");
  const adminCard = document.getElementById("admin-card");
  const loginForm = document.getElementById("login-form");
  const loginMsg = document.getElementById("login-msg");
  const sendForm = document.getElementById("send-form");
  const sendMsg = document.getElementById("send-msg");
  const subscriberCount = document.getElementById("subscriber-count");
  const subscriberList = document.getElementById("subscriber-list");
  const logoutBtn = document.getElementById("logout-btn");

  async function loadSubscribers() {
    const response = await fetch("/api/admin/subscribers", { credentials: "include" });
    if (response.status === 401) {
      authCard?.classList.remove("hidden");
      adminCard?.classList.add("hidden");
      return false;
    }
    const payload = await response.json();
    if (!response.ok) {
      throw new Error(payload.error || "Failed to load subscribers.");
    }

    authCard?.classList.add("hidden");
    adminCard?.classList.remove("hidden");
    if (subscriberCount) {
      subscriberCount.textContent = `${payload.count} active subscriber${payload.count === 1 ? "" : "s"}`;
    }
    if (subscriberList) {
      subscriberList.innerHTML = "";
      payload.subscribers.forEach((entry) => {
        const item = document.createElement("li");
        item.className = "px-3 py-2 text-gray-700 dark:text-gray-300";
        item.textContent = entry.email;
        subscriberList.appendChild(item);
      });
    }
    return true;
  }

  loginForm?.addEventListener("submit", async (event) => {
    event.preventDefault();
    const username = document.getElementById("username")?.value?.trim();
    const password = document.getElementById("password")?.value || "";
    loginMsg.textContent = "Logging in...";

    const response = await fetch("/api/admin/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ username, password }),
    });
    const payload = await response.json();
    if (!response.ok) {
      loginMsg.textContent = payload.error || "Login failed.";
      loginMsg.className = "mt-3 text-sm text-red-600 dark:text-red-400";
      return;
    }
    loginMsg.textContent = "";
    await loadSubscribers();
  });

  const postSelect = document.getElementById("post-select");
  postSelect?.addEventListener("change", () => {
    const selected = postSelect.options[postSelect.selectedIndex];
    if (!selected?.value) return;
    const titleInput = document.getElementById("post-title");
    const slugInput = document.getElementById("post-slug");
    const summaryInput = document.getElementById("post-summary");
    if (titleInput) titleInput.value = selected.dataset.title || "";
    if (slugInput) slugInput.value = selected.value;
    if (summaryInput) summaryInput.value = selected.dataset.description || "";
  });

  sendForm?.addEventListener("submit", async (event) => {
    event.preventDefault();
    const title = document.getElementById("post-title")?.value?.trim();
    const slug = document.getElementById("post-slug")?.value?.trim();
    const summary = document.getElementById("post-summary")?.value?.trim();
    const previewText = document.getElementById("preview-text")?.value?.trim();

    sendMsg.textContent = "Sending...";
    sendMsg.className = "mt-3 text-sm text-gray-500 dark:text-gray-400";

    const response = await fetch("/api/admin/send-blog", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ title, slug, summary, previewText }),
    });
    const payload = await response.json();
    if (!response.ok) {
      sendMsg.textContent = payload.error || "Send failed.";
      sendMsg.className = "mt-3 text-sm text-red-600 dark:text-red-400";
      return;
    }

    sendMsg.textContent = `Sent to ${payload.attempted} subscriber${payload.attempted === 1 ? "" : "s"}.`;
    sendMsg.className = "mt-3 text-sm text-emerald-600 dark:text-emerald-400";
  });

  logoutBtn?.addEventListener("click", async () => {
    await fetch("/api/admin/logout", {
      method: "POST",
      credentials: "include",
    });
    authCard?.classList.remove("hidden");
    adminCard?.classList.add("hidden");
  });

  loadSubscribers().catch(() => {
    if (subscriberCount) {
      subscriberCount.textContent = "Login required.";
    }
  });
</script>
