---
import Layout from "../../layouts/Layout.astro";
---

<Layout
  title="Unsubscribe â€” Robert McCaffrey"
  description="Unsubscribe from Robert McCaffrey blog email updates."
>
  <section class="max-w-xl mx-auto px-4 sm:px-6 py-20">
    <div class="rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 p-6 sm:p-8">
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Unsubscribe</h1>
      <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Enter your email to stop receiving blog update emails.</p>

      <form id="unsubscribe-form" class="mt-6 space-y-3">
        <input
          id="unsubscribe-email"
          type="email"
          required
          placeholder="you@company.com"
          class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 text-gray-900 dark:text-white"
        />
        <button type="submit" class="px-4 py-2.5 rounded-lg bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-semibold">
          Unsubscribe
        </button>
      </form>

      <p id="unsubscribe-msg" class="mt-3 text-sm text-gray-500 dark:text-gray-400"></p>
    </div>
  </section>
</Layout>

<script>
  const form = document.getElementById("unsubscribe-form");
  const input = document.getElementById("unsubscribe-email");
  const message = document.getElementById("unsubscribe-msg");

  const params = new URLSearchParams(window.location.search);
  const emailParam = params.get("email");
  if (emailParam && input) {
    input.value = emailParam;
  }

  form?.addEventListener("submit", async (event) => {
    event.preventDefault();
    const email = input?.value?.trim();
    if (!email) {
      return;
    }

    const response = await fetch("/api/newsletter/unsubscribe", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email }),
    });
    const payload = await response.json();

    if (!response.ok) {
      message.textContent = payload.error || "Unable to unsubscribe.";
      message.className = "mt-3 text-sm text-red-600 dark:text-red-400";
      return;
    }

    message.textContent = "You have been unsubscribed.";
    message.className = "mt-3 text-sm text-emerald-600 dark:text-emerald-400";
  });
</script>
